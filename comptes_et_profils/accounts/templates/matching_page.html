{% load static %}
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Matching</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
</head>
<body>
<div class="container mt-4">
    <h2>Choisissez un point de départ</h2>
    {% if message %}
<div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}
    <h4>Choisissez uniquement le point de départ (vert). Le point d'arrivée est déjà défini.</h4>
    
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <h2>Page de Matching</h2>
                <p>Cette page vous permet de sélectionner un point de départ sur la carte. Le point d’arrivée est fixe.</p>
            </div>
        </div>
    <form method="post">
        {% csrf_token %}
        {{ form.start_lat }}
        {{ form.start_lng }}

        <div class="mb-3">
            <label class="form-label">Heure de départ :</label>
            {{ form.heure_depart }}
        </div>

        <div id="map" style="height: 500px;"></div>
        <p class="text-danger mt-2" id="error-msg"></p>
        <button type="submit" class="btn btn-success mt-3">Valider le trajet</button>
    </form>
</div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([6.4970, 2.6030], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
    const map = L.map('map').setView([6.4970, 2.6030], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const endCoords = [6.4178, 2.3408];
    L.marker(endCoords, {
        icon: L.icon({
            iconUrl: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
            iconSize: [32, 32]
        })
    }).addTo(map).bindPopup("Arrivée fixe");

    let startMarker = null;

    map.on('click', function(e) {
        if (startMarker) map.removeLayer(startMarker);
        startMarker = L.marker(e.latlng, {
            icon: L.icon({
                iconUrl: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png',
                iconSize: [32, 32]
            })
        }).addTo(map).bindPopup("Départ").openPopup();

        document.getElementById("id_start_lat").value = e.latlng.lat;
        document.getElementById("id_start_lng").value = e.latlng.lng;
    });
</script>
</body>
</html>